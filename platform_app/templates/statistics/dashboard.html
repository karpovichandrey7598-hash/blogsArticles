{% extends "base.html" %}

{% block title %}Статистика{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Моя статистика</h1>
    <p class="card-subtitle">Аналітика ваших публікацій</p>
</div>

<div class="card">
    <h2>Загальна статистика</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <div style="text-align: center; padding: 20px; background: var(--bg-dark); border-radius: var(--radius);">
            <div style="font-size: 32px; font-weight: 700; color: var(--primary);">{{ total_posts }}</div>
            <div style="color: var(--text-light); margin-top: 8px;">Всього постів</div>
        </div>
        <div style="text-align: center; padding: 20px; background: var(--bg-dark); border-radius: var(--radius);">
            <div style="font-size: 32px; font-weight: 700; color: var(--secondary);">{{ total_views }}</div>
            <div style="color: var(--text-light); margin-top: 8px;">Всього переглядів</div>
        </div>
        <div style="text-align: center; padding: 20px; background: var(--bg-dark); border-radius: var(--radius);">
            <div style="font-size: 32px; font-weight: 700; color: var(--primary);">{{ ai_generated_count }}</div>
            <div style="color: var(--text-light); margin-top: 8px;">Постів з ШІ</div>
        </div>
        <div style="text-align: center; padding: 20px; background: var(--bg-dark); border-radius: var(--radius);">
            <div style="font-size: 32px; font-weight: 700; color: var(--secondary);">
                {{ "%.1f"|format((ai_generated_count / total_posts * 100) if total_posts > 0 else 0) }}%
            </div>
            <div style="color: var(--text-light); margin-top: 8px;">Використання ШІ</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>Активність по днях (останні 30 днів)</h2>
    <canvas id="activityChart" style="max-height: 300px;"></canvas>
</div>

<div class="card">
    <h2>Використання ШІ</h2>
    <canvas id="aiUsageChart" style="max-height: 250px;"></canvas>
</div>

<div class="card">
    <h2>Топ-5 найпопулярніших постів</h2>
    {% if top_posts %}
        <div style="margin-top: 16px;">
            {% for post in top_posts %}
                <div style="padding: 12px; border-bottom: 1px solid var(--border);">
                    <a href="{{ url_for('posts.view_post', slug=post.slug) }}" style="font-weight: 600;">{{ post.title }}</a>
                    <div style="color: var(--text-light); font-size: 14px; margin-top: 4px;">
                        {{ post.view_count }} переглядів • {{ post.published_at.strftime('%d.%m.%Y') }}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-muted">Поки що немає постів</p>
    {% endif %}
</div>

<script>
    // Дані для діаграм
    const daysData = {{ days_data | tojson }};
    const aiUsage = {{ ai_usage | tojson }};
    
    // Діаграма активності
    const daysLabels = Object.keys(daysData).reverse();
    const daysValues = Object.values(daysData).reverse();
    
    new Chart(document.getElementById('activityChart'), {
        type: 'line',
        data: {
            labels: daysLabels.map(d => d.split('-').slice(1).join('-')),
            datasets: [{
                label: 'Постів за день',
                data: daysValues,
                borderColor: 'rgb(37, 99, 235)',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Діаграма використання ШІ
    new Chart(document.getElementById('aiUsageChart'), {
        type: 'doughnut',
        data: {
            labels: ['З ШІ', 'Без ШІ'],
            datasets: [{
                data: [aiUsage.with_ai, aiUsage.without_ai],
                backgroundColor: [
                    'rgb(37, 99, 235)',
                    'rgb(229, 231, 235)'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
</script>
{% endblock %}

